#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <dirent.h>
#include <sys/stat.h>
#include "libSearch.h"
#include "crypt.h"


int cryptFolder(char *folder){
    char keyName[3]="key";
    generateAESKey(keyName);
    DIR* directory = opendir(folder);

    if (directory == NULL) {
        printf("error");
        return 42;
    }
    struct dirent* entry;
    while ((entry = readdir(directory)) != NULL) {
        if(strcmp(entry->d_name, "..") != 0 && strcmp(entry->d_name, ".") != 0 ){
            if(isFolder(getPath(appendFolder(folder,entry->d_name))) == 1){
                cryptFolder(getPath(appendFolder(folder,entry->d_name)));
            } else{
                //printf("%s ", getPathappendFileName("encrypted", folder,entry->d_name));
                //printf("%s ", appendFolder(folder,(appendFileName("encrypted_", entry->d_name))));
                encryptFile(getPath(appendFolder(folder,entry->d_name)), appendFolder(folder,(appendFileName("encrypted_", entry->d_name))), keyName);
                //printf("crypt-> %s \n", getPath(appendFolder(folder,entry->d_name)));
            }

        }
    }



    closedir(directory);
    return 0;
}


int decryptFolder(char *folder){
    DIR* directory = opendir(folder);

    if (directory == NULL) {
        printf("error");
        return 42;
    }
    struct dirent* entry;
    while ((entry = readdir(directory)) != NULL) {
        if(strcmp(entry->d_name, "..") != 0 && strcmp(entry->d_name, ".") != 0 ){
            if(isFolder(getPath(appendFolder(folder,entry->d_name))) == 1){
                decryptFolder(getPath(appendFolder(folder,entry->d_name)));
            } else{
                
                if(strstr(entry->d_name, "encrypted_")!= NULL){

                    printf("%s \n", appendFolder(folder,getPath(appendFolder(folder,entry->d_name))));
                    //decryptFile(getPath(appendFolder(folder,entry->d_name)),appendFolder(folder,(appendFileName("decrypted_", nameFile))) , "key");
                
                
                //printf("decrypt-> %s \n", getPath(appendFolder(folder,entry->d_name)));
            }

        }
    }

    }

    closedir(directory);
    return 0;

}


int main(void){
    cryptFolder("../test");
    //decryptFolder("../test");


    return 0;
}