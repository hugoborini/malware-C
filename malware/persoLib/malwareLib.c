#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <dirent.h>
#include <sys/stat.h>
#include "libSearch.h"
#include "crypt.h"

int cryptFolder(char *folder, char *keyName){
    DIR* directory = opendir(folder);

    if (directory == NULL) {
        printf("error");
        return 42;
    }
    struct dirent* entry;
    while ((entry = readdir(directory)) != NULL) {
        if(strcmp(entry->d_name, "..") != 0 && strcmp(entry->d_name, ".") != 0 ){
            if(isFolder(getPath(appendFolder(folder,entry->d_name))) == 1){
                cryptFolder(getPath(appendFolder(folder,entry->d_name)), keyName);
            } else{
                encryptFile(appendFolder(folder,entry->d_name), appendFolder(folder,(appendFileName("encrypted_", entry->d_name))), keyName);
                remove(appendFolder(folder,entry->d_name)); 
            }

        }
    }



    closedir(directory);
    return 0;
}



int decryptFolder(char *folder, char *keyName){
    DIR* directory = opendir(folder);

    if (directory == NULL) {
        printf("error");
        return 42;
    }
    struct dirent* entry;
    while ((entry = readdir(directory)) != NULL) {
        if(strcmp(entry->d_name, "..") != 0 && strcmp(entry->d_name, ".") != 0 ){
            if(isFolder(getPath(appendFolder(folder,entry->d_name))) == 1){
                decryptFolder(getPath(appendFolder(folder,entry->d_name)), keyName);
            } else{
                if(strstr(entry->d_name, "encrypted_")) {
                    char *newName=supStr(entry->d_name, "encrypted_");
                    char *acutalFile=appendFolder(folder, entry->d_name);
                    char *newFile= appendFolder(folder,(appendFileName("decrypted_", newName)));
                    decryptFile(acutalFile, newFile, keyName); 
                    remove(appendFolder(folder,entry->d_name)); 
                }
            }
    }

    }

    closedir(directory);
    return 0;

}